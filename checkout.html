
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>THE TICKET – Étape finale</title>
  <style>
    body {
      margin: 0;
      background-color: #000;
      color: #fff;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      text-align: center;
      padding: 20px;
    }
    p.message {
      font-style: italic;
      font-size: 0.9em;
      color: #888;
      margin-bottom: 20px;
    }
    #payment-wrapper {
      background: #111;
      padding: 30px 20px;
      border-radius: 8px;
      width: 100%;
      max-width: 400px;
    }
    #email {
      margin-bottom: 15px;
      padding: 10px;
      width: 100%;
      border-radius: 4px;
      border: none;
    }
    button {
      background-color: #fff;
      color: #000;
      border: none;
      padding: 12px 25px;
      border-radius: 5px;
      font-weight: bold;
      cursor: pointer;
      width: 100%;
    }
    button:hover {
      background-color: #444;
      color: #fff;
    }
    #payment-section {
      display: none;
      margin-top: 20px;
    }
    #payment-request-button {
      margin-bottom: 20px;
    }
    #payment-message {
      margin-top: 10px;
      font-size: 0.9em;
      color: #ccc;
    }
  </style>
  <script src="https://js.stripe.com/v3/">
    // Anti-fuite
    let hasInteracted = false;
    document.getElementById("continue").addEventListener("click", () => { hasInteracted = true; });
    document.addEventListener("mouseleave", function(e) {
      if (!hasInteracted && e.clientY < 10) {
        const msg = document.createElement("div");
        msg.textContent = "Revenir plus tard ne change rien.";
        msg.style.position = "fixed";
        msg.style.top = "10px";
        msg.style.left = "50%";
        msg.style.transform = "translateX(-50%)";
        msg.style.background = "#111";
        msg.style.color = "#aaa";
        msg.style.padding = "10px 20px";
        msg.style.borderRadius = "5px";
        msg.style.fontSize = "0.9em";
        msg.style.fontStyle = "italic";
        document.body.appendChild(msg);
        setTimeout(() => msg.remove(), 4000);
      }
    });
    </script>

</head>
<body>
  <p class="message">Certains s’arrêtent ici. Pas toi.</p>
  <div id="payment-wrapper">
    <input type="email" id="email" placeholder="Adresse e-mail" required style="padding: 12px; font-size: 1em; border-radius: 4px; border: none; width: 100%; box-sizing: border-box; margin-bottom: 15px;" />
    <button id="continue">Continuer</button>

    <div id="payment-section">
      <div id="payment-request-button"></div>
      <div id="card-element" style="margin-bottom: 20px;"></div>
      <button id="submit-payment">Valider le paiement</button>
      <div id="payment-message"></div>
    </div>
  </div>

  <script>
    const stripe = Stripe("pk_live_51RBtiaJpYIvufaevJDoND2KZrLz2QQ6Ebq31CSHZnbOOCjDiexe3O69ivCjdT8pMFFhHi3NOj1SDORTXSrVoaWJd00Q5OnefrV");
    const elements = stripe.elements();
    const card = elements.create("card", { style: { base: { color: "#fff" } } });

    document.getElementById("continue").addEventListener("click", async () => {
      const email = document.getElementById("email").value;
      if (!email || !email.includes("@")) {
        alert("Merci d'entrer une adresse e-mail valide.");
        return;
      }

      const res = await fetch("/.netlify/functions/create-payment-intent", {
        method: "POST",
        body: JSON.stringify({ email })
      });
      const data = await res.json();
      const clientSecret = data.clientSecret;

      document.getElementById("payment-section").style.display = "block";
      card.mount("#card-element");

      const paymentRequest = stripe.paymentRequest({
        country: 'FR',
        currency: 'eur',
        total: { label: 'THE TICKET', amount: 100 },
        requestPayerName: true,
        requestPayerEmail: true,
      });

      const prButton = elements.create('paymentRequestButton', {
        paymentRequest,
        style: {
          paymentRequestButton: {
            type: 'default',
            theme: 'dark',
            height: '44px',
          },
        },
      });

      paymentRequest.canMakePayment().then(function(result) {
        if (result) {
          prButton.mount('#payment-request-button');
        } else {
          document.getElementById('payment-request-button').style.display = 'none';
        }
      });

      document.getElementById("submit-payment").addEventListener("click", async (e) => {
        const result = await stripe.confirmCardPayment(clientSecret, {
          payment_method: { card: card }
        });

        if (result.error) {
          document.getElementById("payment-message").textContent = result.error.message;
        } else {
          window.location.href = "confirmation.html";
        }
      });
    });
  
    // Anti-fuite
    let hasInteracted = false;
    document.getElementById("continue").addEventListener("click", () => { hasInteracted = true; });
    document.addEventListener("mouseleave", function(e) {
      if (!hasInteracted && e.clientY < 10) {
        const msg = document.createElement("div");
        msg.textContent = "Revenir plus tard ne change rien.";
        msg.style.position = "fixed";
        msg.style.top = "10px";
        msg.style.left = "50%";
        msg.style.transform = "translateX(-50%)";
        msg.style.background = "#111";
        msg.style.color = "#aaa";
        msg.style.padding = "10px 20px";
        msg.style.borderRadius = "5px";
        msg.style.fontSize = "0.9em";
        msg.style.fontStyle = "italic";
        document.body.appendChild(msg);
        setTimeout(() => msg.remove(), 4000);
      }
    });
    </script>

</body>
</html>
